<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>文档扫描仪 - 模拟Lens</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* 主容器 */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* 头部 */
        .header {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            position: relative;
        }
        
        .logo {
            font-weight: 700;
            font-size: 20px;
            color: #4a8cff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo i {
            font-size: 22px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
        }
        
        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .icon-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 相机视图 */
        .camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }
        
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
            //transform: scaleX(-1); /* 镜像翻转 */
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .document-outline {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 70%;
            border: 2px dashed #4a8cff;
            border-radius: 8px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
        }
        
        .corner {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 2px solid #4a8cff;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .corner-tl {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
            border-radius: 8px 0 0 0;
        }
        
        .corner-tr {
            top: -2px;
            right: -2px;
            border-left: none;
            border-bottom: none;
            border-radius: 0 8px 0 0;
        }
        
        .corner-bl {
            bottom: -2px;
            left: -2px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 8px;
        }
        
        .corner-br {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 8px 0;
        }
        
        /* 拍照按钮 */
        .capture-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 5px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .capture-btn:active {
            transform: scale(0.95);
            background: #f0f0f0;
        }
        
        .capture-inner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        /* 侧边栏 - 扫描文档列表 */
        .sidebar {
            position: absolute;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100%;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 200;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.open {
            right: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-sidebar {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        
        .scans-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .scan-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scan-item:active {
            transform: scale(0.98);
        }
        
        .scan-item.selected {
            border: 2px solid #4a8cff;
        }
        
        .scan-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .scan-info {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scan-page-number {
            font-weight: 600;
            color: #4a8cff;
        }
        
        .scan-actions {
            display: flex;
            gap: 8px;
        }
        
        .scan-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* PDF 操作栏 */
        .pdf-actions {
            padding: 16px;
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.8);
            margin-top: auto;
        }
        
        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .save-pdf {
            background: #4a8cff;
            color: white;
        }
        
        .clear-all {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        /* 编辑模式 */
        .edit-mode {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 300;
            display: none;
            flex-direction: column;
        }
        
        .edit-toolbar {
            padding: 16px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .edit-tools {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .tool-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .tool-btn.active {
            background: #4a8cff;
            color: white;
        }
        
        .edit-canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 20px;
        }
        
        #editCanvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* 加载动画 */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #4a8cff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                right: -100%;
            }
            
            .document-outline {
                width: 90%;
                height: 60%;
            }
        }
        
        /* 提示信息 */
        .hint {
            position: absolute;
            bottom: 120px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            padding: 0 20px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-camera"></i>
                <span>文档扫描仪</span>
            </div>
            <div class="action-buttons">
                <button class="icon-btn" id="toggleSidebar">
                    <i class="fas fa-images"></i>
                </button>
                <button class="icon-btn" id="toggleFlash">
                    <i class="fas fa-bolt"></i>
                </button>
            </div>
        </div>
        
        <!-- 相机视图 -->
        <div class="camera-container">
            <video id="videoElement" autoplay playsinline></video>
            <div class="camera-overlay">
                <div class="document-outline">
                    <div class="corner corner-tl"></div>
                    <div class="corner corner-tr"></div>
                    <div class="corner corner-bl"></div>
                    <div class="corner corner-br"></div>
                </div>
            </div>
            <div class="hint">将文档置于框内，确保光线充足</div>
        </div>
        
        <!-- 拍照控制 -->
        <div class="capture-controls">
            <div class="capture-btn" id="captureBtn">
                <div class="capture-inner"></div>
            </div>
        </div>
        
        <!-- PDF 操作栏 -->
        <div class="pdf-actions">
            <button class="action-btn save-pdf" id="savePdf">
                <i class="fas fa-file-pdf"></i>
                <span>生成PDF</span>
            </button>
            <button class="action-btn clear-all" id="clearAll">
                <i class="fas fa-trash"></i>
                <span>清空所有</span>
            </button>
        </div>
        
        <!-- 侧边栏 - 扫描文档列表 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">扫描文档 (<span id="scanCount">0</span>)</div>
                <button class="close-sidebar" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="scans-list" id="scansList">
                <!-- 扫描项目将动态添加到这里 -->
            </div>
        </div>
        
        <!-- 编辑模式 -->
        <div class="edit-mode" id="editMode">
            <div class="edit-toolbar">
                <button class="icon-btn" id="closeEdit">
                    <i class="fas fa-times"></i>
                </button>
                <div class="edit-tools">
                    <button class="tool-btn active" data-tool="crop">
                        <i class="fas fa-crop"></i>
                        <span>裁剪</span>
                    </button>
                    <button class="tool-btn" data-tool="filter">
                        <i class="fas fa-sliders-h"></i>
                        <span>白板模式</span>
                    </button>
                    <button class="tool-btn" data-tool="rotate">
                        <i class="fas fa-redo"></i>
                        <span>旋转</span>
                    </button>
                    <button class="tool-btn" data-tool="contrast">
                        <i class="fas fa-adjust"></i>
                        <span>对比度</span>
                    </button>
                </div>
                <button class="icon-btn" id="saveEdit">
                    <i class="fas fa-check"></i>
                </button>
            </div>
            <div class="edit-canvas-container">
                <canvas id="editCanvas"></canvas>
            </div>
        </div>
        
        <!-- 加载动画 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>正在处理图像...</div>
        </div>
    </div>
    
    <!-- 引入jsPDF库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        // 全局变量
        let videoStream = null;
        let scans = [];
        let currentEditIndex = null;
        let currentTool = 'crop';
        let flashOn = false;
        
        // DOM元素
        const videoElement = document.getElementById('videoElement');
        const captureBtn = document.getElementById('captureBtn');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('sidebar');
        const scansList = document.getElementById('scansList');
        const scanCount = document.getElementById('scanCount');
        const editMode = document.getElementById('editMode');
        const editCanvas = document.getElementById('editCanvas');
        const editCtx = editCanvas.getContext('2d');
        const closeEditBtn = document.getElementById('closeEdit');
        const saveEditBtn = document.getElementById('saveEdit');
        const toolButtons = document.querySelectorAll('.tool-btn');
        const savePdfBtn = document.getElementById('savePdf');
        const clearAllBtn = document.getElementById('clearAll');
        const loading = document.getElementById('loading');
        const toggleFlashBtn = document.getElementById('toggleFlash');
        
        // 初始化相机
        async function initCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
            } catch (error) {
                console.error('无法访问相机:', error);
                alert('无法访问相机。请确保已授予相机权限。');
            }
        }
        
        // 拍照
        captureBtn.addEventListener('click', captureImage);
        
        async function captureImage() {
            if (!videoStream) return;
            
            // 显示加载动画
            loading.style.display = 'flex';
            
            // 创建临时canvas捕获视频帧
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // 设置canvas尺寸为视频实际尺寸
            tempCanvas.width = videoElement.videoWidth;
            tempCanvas.height = videoElement.videoHeight;
            
            // 绘制视频帧到canvas（考虑镜像翻转）
            //tempCtx.translate(tempCanvas.width, 0);
            //tempCtx.scale(-1, 1);
            tempCtx.drawImage(videoElement, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // 获取图像数据
            const imageData = tempCanvas.toDataURL('image/jpeg', 0.9);
            
            // 创建扫描对象
            const scan = {
                id: Date.now(),
                imageData: imageData,
                editedImageData: null,
                pageNumber: scans.length + 1,
                filter: 'none',
                rotation: 0,
                crop: { x: 0, y: 0, width: 1, height: 1 }
            };
            
            // 添加到扫描列表
            scans.push(scan);
            
            // 更新UI
            updateScansList();
            
            // 隐藏加载动画
            setTimeout(() => {
                loading.style.display = 'none';
                
                // 自动打开编辑模式
                openEditMode(scans.length - 1);
            }, 500);
        }
        
        // 更新扫描列表
        function updateScansList() {
            scansList.innerHTML = '';
            scanCount.textContent = scans.length;
            
            scans.forEach((scan, index) => {
                const scanItem = document.createElement('div');
                scanItem.className = 'scan-item';
                scanItem.dataset.index = index;
                
                // 使用编辑后的图像或原始图像
                const imgSrc = scan.editedImageData || scan.imageData;
                
                scanItem.innerHTML = `
                    <img class="scan-thumbnail" src="${imgSrc}" alt="扫描文档 ${scan.pageNumber}">
                    <div class="scan-info">
                        <div class="scan-page-number">第 ${scan.pageNumber} 页</div>
                        <div class="scan-actions">
                            <button class="scan-btn edit-scan" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="scan-btn delete-scan" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                scansList.appendChild(scanItem);
                
                // 添加事件监听器
                scanItem.querySelector('.edit-scan').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditMode(index);
                });
                
                scanItem.querySelector('.delete-scan').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteScan(index);
                });
                
                scanItem.addEventListener('click', () => {
                    selectScan(index);
                });
            });
        }
        
        // 打开编辑模式
        function openEditMode(index) {
            currentEditIndex = index;
            const scan = scans[index];
            
            // 设置编辑画布尺寸
            const img = new Image();
            img.onload = function() {
                // 计算适合屏幕的尺寸
                const maxWidth = window.innerWidth - 40;
                const maxHeight = window.innerHeight - 150;
                
                let width = img.width;
                let height = img.height;
                
                // 保持宽高比
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                if (height > maxHeight) {
                    width = (maxHeight / height) * width;
                    height = maxHeight;
                }
                
                editCanvas.width = width;
                editCanvas.height = height;
                
                // 绘制图像到编辑画布
                editCtx.clearRect(0, 0, editCanvas.width, editCanvas.height);
                editCtx.save();
                
                // 应用旋转
                if (scan.rotation !== 0) {
                    editCtx.translate(editCanvas.width / 2, editCanvas.height / 2);
                    editCtx.rotate(scan.rotation * Math.PI / 180);
                    
                    // 根据旋转调整绘制位置
                    let drawWidth = editCanvas.width;
                    let drawHeight = editCanvas.height;
                    
                    if (scan.rotation % 180 !== 0) {
                        drawWidth = editCanvas.height;
                        drawHeight = editCanvas.width;
                    }
                    
                    editCtx.drawImage(img, -drawWidth/2, -drawHeight/2, drawWidth, drawHeight);
                    editCtx.restore();
                } else {
                    editCtx.drawImage(img, 0, 0, editCanvas.width, editCanvas.height);
                }
                
                // 应用白板模式滤镜
                if (scan.filter === 'whiteboard') {
                    applyWhiteboardFilter();
                }
                
                // 显示编辑模式
                editMode.style.display = 'flex';
            };
            
            img.src = scan.editedImageData || scan.imageData;
        }
        
        // 应用白板模式滤镜
        function applyWhiteboardFilter() {
            const imageData = editCtx.getImageData(0, 0, editCanvas.width, editCanvas.height);
            const data = imageData.data;
            
            // 增强对比度并减少阴影
            for (let i = 0; i < data.length; i += 4) {
                // 获取RGB值
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 转换为灰度（简单平均）
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // 增强对比度
                let enhanced = gray;
                enhanced = (enhanced - 128) * 1.5 + 128;
                
                // 限制在0-255范围内
                enhanced = Math.max(0, Math.min(255, enhanced));
                
                // 减少阴影（提高暗部）
                if (enhanced < 100) {
                    enhanced = enhanced * 1.3;
                }
                
                // 设置新的RGB值（灰度）
                data[i] = enhanced;
                data[i + 1] = enhanced;
                data[i + 2] = enhanced;
            }
            
            editCtx.putImageData(imageData, 0, 0);
        }
        
        // 保存编辑
        saveEditBtn.addEventListener('click', saveEdit);
        
        function saveEdit() {
            if (currentEditIndex === null) return;
            
            const scan = scans[currentEditIndex];
            
            // 保存编辑后的图像
            scan.editedImageData = editCanvas.toDataURL('image/jpeg', 0.9);
            
            // 应用当前选择的滤镜
            scan.filter = currentTool === 'filter' ? 'whiteboard' : 'none';
            
            // 更新扫描列表
            updateScansList();
            
            // 关闭编辑模式
            closeEditMode();
        }
        
        // 关闭编辑模式
        closeEditBtn.addEventListener('click', closeEditMode);
        
        function closeEditMode() {
            editMode.style.display = 'none';
            currentEditIndex = null;
        }
        
        // 工具按钮点击事件
        toolButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // 移除其他按钮的激活状态
                toolButtons.forEach(b => b.classList.remove('active'));
                // 添加当前按钮的激活状态
                this.classList.add('active');
                
                currentTool = this.dataset.tool;
                
                // 应用工具效果
                applyTool(currentTool);
            });
        });
        
        // 应用工具效果
        function applyTool(tool) {
            if (currentEditIndex === null) return;
            
            const scan = scans[currentEditIndex];
            
            // 重新绘制原始图像
            const img = new Image();
            img.onload = function() {
                editCtx.clearRect(0, 0, editCanvas.width, editCanvas.height);
                editCtx.save();
                
                // 应用旋转
                if (scan.rotation !== 0) {
                    editCtx.translate(editCanvas.width / 2, editCanvas.height / 2);
                    editCtx.rotate(scan.rotation * Math.PI / 180);
                    
                    let drawWidth = editCanvas.width;
                    let drawHeight = editCanvas.height;
                    
                    if (scan.rotation % 180 !== 0) {
                        drawWidth = editCanvas.height;
                        drawHeight = editCanvas.width;
                    }
                    
                    editCtx.drawImage(img, -drawWidth/2, -drawHeight/2, drawWidth, drawHeight);
                    editCtx.restore();
                } else {
                    editCtx.drawImage(img, 0, 0, editCanvas.width, editCanvas.height);
                }
                
                // 根据工具应用效果
                switch(tool) {
                    case 'filter':
                        applyWhiteboardFilter();
                        break;
                    case 'rotate':
                        // 旋转图像
                        scan.rotation = (scan.rotation + 90) % 360;
                        // 重新绘制
                        applyTool('crop'); // 切换回裁剪工具并重新绘制
                        document.querySelector('.tool-btn[data-tool="crop"]').click();
                        break;
                    case 'contrast':
                        // 增强对比度
                        const imageData = editCtx.getImageData(0, 0, editCanvas.width, editCanvas.height);
                        const data = imageData.data;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            // 增强对比度
                            data[i] = ((data[i] - 128) * 1.3) + 128;
                            data[i+1] = ((data[i+1] - 128) * 1.3) + 128;
                            data[i+2] = ((data[i+2] - 128) * 1.3) + 128;
                        }
                        
                        editCtx.putImageData(imageData, 0, 0);
                        break;
                    // 裁剪工具需要手动交互，这里只显示裁剪区域
                    case 'crop':
                        // 绘制裁剪区域边框
                        editCtx.strokeStyle = '#4a8cff';
                        editCtx.lineWidth = 2;
                        editCtx.setLineDash([5, 5]);
                        editCtx.strokeRect(
                            editCanvas.width * 0.1, 
                            editCanvas.height * 0.1, 
                            editCanvas.width * 0.8, 
                            editCanvas.height * 0.8
                        );
                        editCtx.setLineDash([]);
                        break;
                }
            };
            
            img.src = scan.imageData;
        }
        
        // 选择扫描项目
        function selectScan(index) {
            // 移除所有选择
            document.querySelectorAll('.scan-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 添加当前选择
            document.querySelector(`.scan-item[data-index="${index}"]`).classList.add('selected');
        }
        
        // 删除扫描项目
        function deleteScan(index) {
            if (confirm('确定要删除此扫描文档吗？')) {
                scans.splice(index, 1);
                
                // 更新页码
                scans.forEach((scan, i) => {
                    scan.pageNumber = i + 1;
                });
                
                updateScansList();
            }
        }
        
        // 切换侧边栏
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
        });
        
        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });
        
        // 切换闪光灯（模拟）
        toggleFlashBtn.addEventListener('click', () => {
            flashOn = !flashOn;
            toggleFlashBtn.innerHTML = flashOn ? 
                '<i class="fas fa-bolt" style="color: #ffcc00"></i>' : 
                '<i class="fas fa-bolt"></i>';
            
            // 在真实应用中，这里会控制相机闪光灯
            console.log('闪光灯:', flashOn ? '开' : '关');
        });
        
        // 生成PDF
        savePdfBtn.addEventListener('click', generatePDF);
        
        async function generatePDF() {
            if (scans.length === 0) {
                alert('没有扫描文档可生成PDF');
                return;
            }
            
            loading.style.display = 'flex';
            
            try {
                // 使用jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                for (let i = 0; i < scans.length; i++) {
                    const scan = scans[i];
                    
                    // 如果不是第一页，添加新页
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    // 获取图像数据
                    const imgData = scan.editedImageData || scan.imageData;
                    
                    // 将图像添加到PDF
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    // 如果图像高度超过PDF页面，调整大小
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const height = pdfHeight > pageHeight ? pageHeight - 20 : pdfHeight;
                    const width = (imgProps.width * height) / imgProps.height;
                    
                    // 居中显示
                    const x = (pdfWidth - width) / 2;
                    const y = (pageHeight - height) / 2;
                    
                    pdf.addImage(imgData, 'JPEG', x, y, width, height);
                    
                    // 添加页码
                    pdf.setFontSize(10);
                    pdf.setTextColor(150);
                    pdf.text(`第 ${i + 1} 页`, pdfWidth / 2, pageHeight - 10, { align: 'center' });
                }
                
                // 保存PDF
                pdf.save(`文档扫描_${new Date().toLocaleDateString()}.pdf`);
                
                // 显示成功消息
                setTimeout(() => {
                    loading.style.display = 'none';
                    alert(`PDF已生成，包含 ${scans.length} 页文档`);
                }, 1000);
                
            } catch (error) {
                console.error('生成PDF时出错:', error);
                loading.style.display = 'none';
                alert('生成PDF时出错，请重试');
            }
        }
        
        // 清空所有扫描
        clearAllBtn.addEventListener('click', () => {
            if (scans.length === 0) return;
            
            if (confirm(`确定要清空所有 ${scans.length} 个扫描文档吗？`)) {
                scans = [];
                updateScansList();
                sidebar.classList.remove('open');
            }
        });
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', initCamera);
        
        // 添加触摸事件支持
        document.addEventListener('touchstart', function(e) {
            // 防止触摸时触发点击高亮
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') {
                e.target.classList.add('active');
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            // 移除触摸高亮
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') {
                e.target.classList.remove('active');
            }
        }, { passive: true });
        
        // 处理窗口大小变化
        window.addEventListener('resize', function() {
            if (currentEditIndex !== null) {
                // 重新打开编辑模式以调整画布大小
                const tempIndex = currentEditIndex;
                closeEditMode();
                setTimeout(() => openEditMode(tempIndex), 100);
            }
        });
        
        // 提示用户使用说明
        setTimeout(() => {
            if (scans.length === 0) {
                alert('欢迎使用文档扫描仪！\n\n使用说明：\n1. 将文档置于取景框内\n2. 点击圆形按钮拍照\n3. 使用编辑工具优化图像\n4. 生成PDF合集\n\n请确保相机权限已开启。');
            }
        }, 1500);
    </script>
</body>
</html>
